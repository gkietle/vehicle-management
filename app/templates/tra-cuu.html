{% extends "base.html" %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Page Header -->
    <div class="mb-4 sm:mb-6 lg:mb-8">
        <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-800 mb-2">Tra cứu thông tin xe</h2>
        <p class="text-sm sm:text-base text-gray-600">Nhập biển số xe hoặc số CCCD để tra cứu thông tin đăng ký</p>
    </div>

    <!-- Search Form -->
    <div class="bg-white rounded-lg shadow-lg p-5 sm:p-6 lg:p-8 mb-6 sm:mb-8">
        <form id="searchForm" class="space-y-4 sm:space-y-6">
            <!-- Search Type Selection -->
            <div class="mb-4">
                <label class="block text-base sm:text-lg font-medium text-gray-700 mb-3">
                    Chọn hình thức tra cứu
                </label>
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input
                            type="radio"
                            name="search_type"
                            value="bien_so"
                            checked
                            class="w-4 h-4 text-blue-600 focus:ring-blue-500"
                            onchange="toggleSearchType()"
                        >
                        <span class="ml-2 text-sm sm:text-base text-gray-700">Theo biển số xe</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input
                            type="radio"
                            name="search_type"
                            value="cccd"
                            class="w-4 h-4 text-blue-600 focus:ring-blue-500"
                            onchange="toggleSearchType()"
                        >
                        <span class="ml-2 text-sm sm:text-base text-gray-700">Theo số CCCD</span>
                    </label>
                </div>
            </div>

            <!-- License Plate Search -->
            <div id="bienSoSearch">
                <label for="bien_so" class="block text-base sm:text-lg font-medium text-gray-700 mb-2 sm:mb-3">
                    Biển số xe <span class="text-red-500">*</span>
                </label>
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                    <input
                        type="text"
                        id="bien_so"
                        name="bien_so"
                        placeholder="VÍ DỤ: 60B100129"
                        class="flex-1 px-4 py-3 sm:py-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg font-semibold uppercase"
                    >
                    <button
                        type="submit"
                        class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold flex items-center justify-center text-base sm:text-lg"
                    >
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Tra cứu
                    </button>
                </div>
                <p class="mt-3 text-sm sm:text-base text-gray-500 leading-relaxed">Nhập đúng biển số xe không dấu, viết hoa<br class="sm:hidden"> (VD: 60B100129, 60AA10113)</p>
            </div>

            <!-- CCCD Search -->
            <div id="cccdSearch" class="hidden">
                <label for="cccd" class="block text-base sm:text-lg font-medium text-gray-700 mb-2 sm:mb-3">
                    Số CCCD <span class="text-red-500">*</span>
                </label>
                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
                    <input
                        type="text"
                        id="cccd"
                        name="cccd"
                        placeholder="VÍ DỤ: 001234567890"
                        class="flex-1 px-4 py-3 sm:py-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-base sm:text-lg font-semibold"
                    >
                    <button
                        type="submit"
                        class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold flex items-center justify-center text-base sm:text-lg"
                    >
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        Tra cứu
                    </button>
                </div>
                <p class="mt-3 text-sm sm:text-base text-gray-500 leading-relaxed">Nhập đúng số CCCD (12 số)</p>
            </div>
        </form>
    </div>

    <!-- Loading Indicator -->
    <div id="loading" class="hidden bg-blue-50 rounded-lg p-8 text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        <p class="mt-4 text-blue-800 font-medium">Đang tìm kiếm...</p>
    </div>

    <!-- Not Found Message -->
    <div id="notFound" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg">
        <div class="flex items-start">
            <svg class="w-6 h-6 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <div>
                <h3 class="font-bold text-yellow-800 mb-1">Không tìm thấy thông tin</h3>
                <p class="text-yellow-700" id="notFoundMessage">Không tìm thấy biển số trong hệ thống.</p>
                <p class="text-sm text-yellow-600 mt-2">Nếu xe chưa có trong danh sách, bạn có thể <a href="#" onclick="submitNewVehicle()" class="underline font-semibold">gửi yêu cầu thêm mới</a></p>
            </div>
        </div>
    </div>

    <!-- Vehicle List (for multiple results) -->
    <div id="vehicleList" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-5 sm:p-6 lg:p-8 mb-6">
            <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">
                Tìm thấy <span id="vehicleCount" class="text-blue-600"></span> phương tiện
            </h3>
            <p class="text-sm sm:text-base text-gray-600 mb-4">Chọn một phương tiện để xem thông tin chi tiết:</p>
            <div id="vehicleListContent" class="space-y-3"></div>
        </div>
    </div>

    <!-- Search Results -->
    <div id="results" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-5 sm:p-6 lg:p-8 mb-6">
            <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 mb-4 sm:mb-6 flex items-center">
                <svg class="w-6 h-6 sm:w-7 sm:h-7 text-green-600 mr-2 sm:mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Thông tin phương tiện
            </h3>

            <div class="grid sm:grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6">
                <div>
                    <h4 class="text-base sm:text-lg font-semibold text-gray-700 mb-3 sm:mb-4 border-b pb-2">Thông tin xe</h4>
                    <div class="space-y-2 sm:space-y-3">
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Biển số:</span>
                            <span id="result_bien_so" class="text-base sm:text-base font-bold text-gray-900 mt-1 sm:mt-0"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Loại xe:</span>
                            <span id="result_loai_xe" class="text-sm sm:text-base text-gray-900 mt-1 sm:mt-0"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Số khung:</span>
                            <span id="result_so_khung" class="text-sm text-gray-900 mt-1 sm:mt-0 break-all"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Số máy:</span>
                            <span id="result_so_may" class="text-sm text-gray-900 mt-1 sm:mt-0 break-all"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Trạng thái:</span>
                            <span id="result_trang_thai" class="inline-block px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs sm:text-sm font-medium mt-1 sm:mt-0"></span>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 class="text-base sm:text-lg font-semibold text-gray-700 mb-3 sm:mb-4 border-b pb-2">Thông tin chủ xe</h4>
                    <div class="space-y-2 sm:space-y-3">
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Họ tên:</span>
                            <span id="result_ten" class="text-base sm:text-base font-bold text-gray-900 mt-1 sm:mt-0"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Giấy tờ:</span>
                            <span id="result_giay_to" class="text-sm sm:text-base text-gray-900 mt-1 sm:mt-0"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Số giấy tờ:</span>
                            <span id="result_so_giay_to" class="text-sm text-gray-900 mt-1 sm:mt-0 break-all"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Điện thoại:</span>
                            <span id="result_sdt" class="text-sm sm:text-base text-gray-900 mt-1 sm:mt-0"></span>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center">
                            <span class="text-sm sm:text-base text-gray-600 sm:w-32 font-medium sm:font-normal">Khu phố:</span>
                            <span id="result_khu_pho" class="text-sm sm:text-base text-gray-900 mt-1 sm:mt-0"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4 sm:mt-6">
                <h4 class="text-base sm:text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Địa chỉ</h4>
                <div class="space-y-2 sm:space-y-3">
                    <div class="flex flex-col">
                        <span class="text-sm sm:text-base text-gray-600 font-medium">Địa chỉ đăng ký:</span>
                        <span id="result_dia_chi_dk" class="text-sm sm:text-base text-gray-900 mt-1"></span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm sm:text-base text-gray-600 font-medium">Địa chỉ thường trú:</span>
                        <span id="result_dia_chi_tt" class="text-sm sm:text-base text-gray-900 mt-1"></span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-sm sm:text-base text-gray-600 font-medium">Nơi ở hiện tại:</span>
                        <span id="result_noi_o" class="text-sm sm:text-base text-gray-900 mt-1"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Request History Section -->
        <div id="requestHistory" class="bg-white rounded-lg shadow-lg p-5 sm:p-6 mb-6 hidden">
            <h3 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Lịch sử yêu cầu đã gửi
            </h3>
            <p class="text-gray-600 mb-4">Danh sách các yêu cầu cập nhật thông tin bạn đã gửi cho biển số này:</p>
            <div id="requestHistoryContent" class="space-y-3"></div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-gray-50 rounded-lg p-5 sm:p-6">
            <h4 class="text-base sm:text-lg font-bold text-gray-800 mb-4">Thông tin có chính xác không?</h4>
            <div class="grid sm:grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                <button
                    onclick="confirmCorrect()"
                    class="w-full px-6 py-4 sm:py-5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-semibold flex items-center justify-center text-base sm:text-lg"
                >
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Thông tin chính xác
                </button>
                <button
                    onclick="showFormOptions()"
                    class="w-full px-6 py-4 sm:py-5 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition font-semibold flex items-center justify-center text-base sm:text-lg"
                >
                    <svg class="w-5 h-5 sm:w-6 sm:h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    Cần cập nhật thông tin
                </button>
            </div>
        </div>
    </div>

    <!-- Form Selection Modal -->
    <div id="formModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-5 sm:p-6 lg:p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800 mb-4 sm:mb-6">Chọn loại yêu cầu cập nhật</h3>

            <div class="space-y-2 sm:space-y-3">
                <a href="#" onclick="goToForm(1)" class="block p-4 sm:p-5 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition active:bg-blue-100">
                    <div class="text-sm sm:text-base font-semibold text-gray-800">Mẫu 1: Xe và chủ xe đúng (Biển xanh)</div>
                    <p class="text-xs sm:text-sm text-gray-600 mt-1">Xác nhận thông tin chính xác</p>
                </a>

                <a href="#" onclick="goToForm(2)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 2: Có chủ xe nhưng không có xe tại địa bàn (Biển xanh)</div>
                    <p class="text-sm text-gray-600 mt-1">Chủ xe ở địa bàn nhưng xe không có</p>
                </a>

                <a href="#" onclick="goToForm(3)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 3: Có xe nhưng không có chủ xe tại địa bàn (Biển xanh)</div>
                    <p class="text-sm text-gray-600 mt-1">Xe ở địa bàn nhưng chủ xe không có</p>
                </a>

                <a href="#" onclick="goToForm(4)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 4: Không có xe và chủ xe tại địa bàn (Biển xanh)</div>
                    <p class="text-sm text-gray-600 mt-1">Cả xe và chủ đều không ở địa bàn</p>
                </a>

                <a href="#" onclick="goToForm(6)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 6: Xe và chủ xe đúng (Biển trắng/vàng)</div>
                    <p class="text-sm text-gray-600 mt-1">Xác nhận thông tin chính xác</p>
                </a>

                <a href="#" onclick="goToForm(7)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 7: Có chủ xe nhưng không có xe (Biển trắng/vàng)</div>
                    <p class="text-sm text-gray-600 mt-1">Chủ xe ở địa bàn nhưng xe không có</p>
                </a>

                <a href="#" onclick="goToForm(8)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 8: Có xe nhưng không có chủ xe (Biển trắng/vàng)</div>
                    <p class="text-sm text-gray-600 mt-1">Xe ở địa bàn nhưng chủ xe không có</p>
                </a>

                <a href="#" onclick="goToForm(9)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 9: Không có xe và chủ xe (Biển trắng/vàng)</div>
                    <p class="text-sm text-gray-600 mt-1">Cả xe và chủ đều không ở địa bàn</p>
                </a>

                <a href="#" onclick="goToForm(10)" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                    <div class="font-semibold text-gray-800">Mẫu 10: Xe không nằm trong danh sách (Biển trắng/vàng)</div>
                    <p class="text-sm text-gray-600 mt-1">Xe không có trong danh sách ban đầu</p>
                </a>
            </div>

            <button
                onclick="closeFormModal()"
                class="mt-6 w-full px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-semibold"
            >
                Đóng
            </button>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div id="requestDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-5 sm:p-6 lg:p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 sm:mb-6">
                <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800">Chi tiết yêu cầu</h3>
                <button onclick="closeRequestDetailModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div id="requestDetailContent" class="space-y-4">
                <!-- Content will be loaded dynamically -->
            </div>

            <button
                onclick="closeRequestDetailModal()"
                class="mt-6 w-full px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-semibold"
            >
                Đóng
            </button>
        </div>
    </div>
</div>

<script>
    let currentBienSo = '';
    let allVehicles = [];

    function toggleSearchType() {
        const searchType = document.querySelector('input[name="search_type"]:checked').value;
        const bienSoSearch = document.getElementById('bienSoSearch');
        const cccdSearch = document.getElementById('cccdSearch');

        if (searchType === 'bien_so') {
            bienSoSearch.classList.remove('hidden');
            cccdSearch.classList.add('hidden');
        } else {
            bienSoSearch.classList.add('hidden');
            cccdSearch.classList.remove('hidden');
        }
    }

    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const searchType = document.querySelector('input[name="search_type"]:checked').value;
        const formData = new FormData();
        formData.append('search_type', searchType);

        let searchValue = '';
        if (searchType === 'bien_so') {
            searchValue = document.getElementById('bien_so').value.trim().toUpperCase();
            formData.append('bien_so', searchValue);
            currentBienSo = searchValue;
        } else {
            searchValue = document.getElementById('cccd').value.trim();
            formData.append('cccd', searchValue);
        }

        if (!searchValue) {
            alert('Vui lòng nhập thông tin tra cứu');
            return;
        }

        // Show loading, hide others
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');
        document.getElementById('notFound').classList.add('hidden');
        document.getElementById('vehicleList').classList.add('hidden');

        try {
            const response = await fetch('/api/search', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            // Hide loading
            document.getElementById('loading').classList.add('hidden');

            if (data.found) {
                if (data.vehicles && data.vehicles.length > 1) {
                    // Multiple vehicles found (CCCD search)
                    allVehicles = data.vehicles;
                    displayVehicleList(data.vehicles);
                } else if (data.vehicle) {
                    // Single vehicle found
                    currentBienSo = data.vehicle.bien_so;
                    displayResults(data.vehicle);
                }
            } else {
                // Show not found
                document.getElementById('notFound').classList.remove('hidden');
                document.getElementById('notFoundMessage').textContent = data.message;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('loading').classList.add('hidden');
            alert('Có lỗi xảy ra khi tìm kiếm. Vui lòng thử lại.');
        }
    });

    function displayVehicleList(vehicles) {
        const listContent = document.getElementById('vehicleListContent');
        listContent.innerHTML = '';

        document.getElementById('vehicleCount').textContent = vehicles.length;

        vehicles.forEach((vehicle, index) => {
            const card = document.createElement('div');
            card.className = 'border-2 border-gray-200 rounded-lg p-4 hover:border-blue-500 hover:bg-blue-50 transition cursor-pointer';
            card.onclick = () => selectVehicle(index);

            card.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                    <div>
                        <div class="font-bold text-lg text-gray-800">${vehicle.bien_so || '-'}</div>
                        <div class="text-sm text-gray-600">${vehicle.ten || '-'}</div>
                        <div class="text-xs text-gray-500">${vehicle.loai_xe || '-'}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">CCCD: ${vehicle.so_giay_to || '-'}</div>
                        <div class="text-xs text-gray-500">${vehicle.khu_pho || '-'}</div>
                    </div>
                </div>
            `;

            listContent.appendChild(card);
        });

        // Hide other sections, show vehicle list
        document.getElementById('vehicleList').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');
    }

    function selectVehicle(index) {
        const vehicle = allVehicles[index];
        currentBienSo = vehicle.bien_so;

        // Hide vehicle list, show details
        document.getElementById('vehicleList').classList.add('hidden');
        displayResults(vehicle);
    }

    async function displayResults(vehicle) {
        // Fill in data
        document.getElementById('result_bien_so').textContent = vehicle.bien_so || '-';
        document.getElementById('result_loai_xe').textContent = vehicle.loai_xe || '-';
        document.getElementById('result_so_khung').textContent = vehicle.so_khung || '-';
        document.getElementById('result_so_may').textContent = vehicle.so_may || '-';
        document.getElementById('result_trang_thai').textContent = vehicle.trang_thai_xe || '-';
        document.getElementById('result_ten').textContent = vehicle.ten || '-';
        document.getElementById('result_giay_to').textContent = vehicle.loai_giay_to || '-';
        document.getElementById('result_so_giay_to').textContent = vehicle.so_giay_to || '-';
        document.getElementById('result_sdt').textContent = vehicle.so_dien_thoai || '-';
        document.getElementById('result_khu_pho').textContent = vehicle.khu_pho || '-';
        document.getElementById('result_dia_chi_dk').textContent = vehicle.dia_chi_dang_ky_xe || '-';
        document.getElementById('result_dia_chi_tt').textContent = vehicle.dia_chi_thuong_tru || '-';
        document.getElementById('result_noi_o').textContent = vehicle.noi_o_hien_tai || '-';

        // Show results
        document.getElementById('results').classList.remove('hidden');

        // Load request history for this vehicle
        await loadRequestHistory(vehicle.bien_so);
    }

    async function loadRequestHistory(bienSo) {
        try {
            const response = await fetch(`/api/requests/bien-so/${bienSo}`);
            const data = await response.json();

            if (data.success && data.total > 0) {
                displayRequestHistory(data.requests);
            } else {
                document.getElementById('requestHistory').classList.add('hidden');
            }
        } catch (error) {
            console.error('Error loading request history:', error);
            document.getElementById('requestHistory').classList.add('hidden');
        }
    }

    function displayRequestHistory(requests) {
        const container = document.getElementById('requestHistoryContent');
        container.innerHTML = '';

        requests.forEach(req => {
            const card = document.createElement('div');
            card.className = 'border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 hover:shadow-md transition cursor-pointer';

            const statusBadge = getStatusBadge(req.trang_thai);
            const versionBadge = `<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs font-medium">v${req.version}</span>`;
            const latestBadge = req.is_latest_approved ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">✓ LATEST</span>' : '';

            card.innerHTML = `
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-semibold text-gray-800">Mẫu ${req.loai_mau}</span>
                            ${versionBadge}
                            ${latestBadge}
                            ${statusBadge}
                        </div>
                        <div class="text-sm text-gray-600">
                            <div>Mã YC: <span class="font-mono text-blue-600">${req.id}</span></div>
                            <div>Ngày gửi: ${req.ngay_tao}</div>
                            ${req.batch_name ? `<div>Đợt: <span class="text-purple-600">${req.batch_name}</span></div>` : ''}
                            ${req.nguoi_duyet ? `<div>Người duyệt: ${req.nguoi_duyet} (${req.ngay_duyet})</div>` : ''}
                            ${req.ly_do_tu_choi ? `<div class="text-red-600 mt-1">Lý do từ chối: ${req.ly_do_tu_choi}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex items-center text-gray-400">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </div>
                </div>
            `;

            // Add click handler to show detail modal
            card.addEventListener('click', () => showRequestDetail(req.id));

            container.appendChild(card);
        });

        document.getElementById('requestHistory').classList.remove('hidden');
    }

    function getStatusBadge(status) {
        const badges = {
            'pending': '<span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs font-medium">Chờ duyệt</span>',
            'approved': '<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">Đã duyệt</span>',
            'rejected': '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-medium">Từ chối</span>',
            'processed': '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-medium">Đã xử lý</span>'
        };
        return badges[status] || '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs">Không xác định</span>';
    }

    async function showRequestDetail(requestId) {
        try {
            const response = await fetch(`/api/request/status/${requestId}`);
            const data = await response.json();

            if (!data.success) {
                alert('Không thể tải thông tin yêu cầu');
                return;
            }

            const req = data.request;
            const content = document.getElementById('requestDetailContent');

            // Form templates mapping
            const formTemplates = {
                1: 'Xe và chủ xe đúng với danh sách',
                2: 'Có chủ xe nhưng không có xe tại địa bàn',
                3: 'Có xe nhưng không có chủ xe tại địa bàn',
                4: 'Không có xe và chủ xe tại địa bàn',
                5: 'Xe không nằm trong danh sách',
                6: 'Xe và chủ xe đúng với danh sách (Biển trắng/vàng)',
                7: 'Có chủ xe nhưng không có xe tại địa bàn (Biển trắng/vàng)',
                8: 'Có xe nhưng không có chủ xe tại địa bàn (Biển trắng/vàng)',
                9: 'Không có xe và chủ xe tại địa bàn (Biển trắng/vàng)',
                10: 'Xe không nằm trong danh sách (Biển trắng/vàng)'
            };

            const statusBadge = getStatusBadge(req.trang_thai);
            const versionBadge = `<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded text-xs font-medium">v${req.version}</span>`;
            const latestBadge = req.is_latest_approved ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-bold">✓ LATEST APPROVED</span>' : '';

            // Helper function to create info row
            const infoRow = (label, value) => value ?
                `<div class="flex justify-between border-b border-gray-100 py-2">
                    <span class="text-gray-600">${label}:</span>
                    <span class="font-semibold text-gray-900 text-right">${value}</span>
                </div>` : '';

            content.innerHTML = `
                <!-- Header Info -->
                <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <h4 class="text-lg font-bold text-gray-800">Mã yêu cầu:</h4>
                        <span class="font-mono text-blue-600 font-bold">${req.id}</span>
                        ${versionBadge}
                        ${latestBadge}
                        ${statusBadge}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div><span class="font-semibold">Loại mẫu:</span> Mẫu ${req.loai_mau} - ${formTemplates[req.loai_mau] || ''}</div>
                        <div><span class="font-semibold">Ngày gửi:</span> ${req.ngay_tao}</div>
                        ${req.nguoi_duyet ? `<div><span class="font-semibold">Người duyệt:</span> ${req.nguoi_duyet}</div>` : ''}
                        ${req.ngay_duyet ? `<div><span class="font-semibold">Ngày duyệt:</span> ${req.ngay_duyet}</div>` : ''}
                        ${req.batch_name ? `<div><span class="font-semibold">Đợt dữ liệu:</span> <span class="text-purple-600">${req.batch_name}</span></div>` : ''}
                    </div>
                    ${req.ly_do_tu_choi ? `<div class="mt-3 p-3 bg-red-50 border border-red-200 rounded"><span class="font-semibold text-red-800">Lý do từ chối:</span> <span class="text-red-700">${req.ly_do_tu_choi}</span></div>` : ''}
                </div>

                <!-- Vehicle Info -->
                <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-gray-200">
                        <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Thông tin xe
                    </h4>
                    <div class="text-sm space-y-1">
                        ${infoRow('Biển số', req.bien_so)}
                        ${infoRow('Loại xe', req.loai_xe)}
                        ${infoRow('Màu biển', req.mau_bien)}
                        ${infoRow('Số khung', req.so_khung)}
                        ${infoRow('Số máy', req.so_may)}
                        ${infoRow('Tình trạng xe', req.tinh_trang_xe)}
                    </div>
                </div>

                <!-- Owner Info -->
                <div class="bg-white border-2 border-gray-200 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-gray-200">
                        <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Thông tin chủ xe
                    </h4>
                    <div class="text-sm space-y-1">
                        ${infoRow('Họ và tên', req.chu_xe)}
                        ${infoRow('Địa chỉ', req.dia_chi_chu_xe)}
                        ${infoRow('Số điện thoại', req.so_dien_thoai_chu_xe)}
                        ${infoRow('Mã số thuế/CCCD', req.ma_so_thue_chu_xe)}
                        ${infoRow('Ngày cấp CCCD', req.ngay_cap_cccd_chu_xe)}
                        ${infoRow('Số GPLX', req.so_gplx_chu_xe)}
                        ${infoRow('Ngày cấp GPLX', req.ngay_cap_gplx_chu_xe)}
                        ${infoRow('Cơ quan cấp GPLX', req.co_quan_cap_gplx_chu_xe)}
                    </div>
                </div>

                <!-- Buyer Info (if exists) -->
                ${req.ten_nguoi_mua ? `
                <div class="bg-white border-2 border-green-200 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-green-200">
                        <svg class="w-5 h-5 inline mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        Thông tin người mua
                    </h4>
                    <div class="text-sm space-y-1">
                        ${infoRow('Họ và tên', req.ten_nguoi_mua)}
                        ${infoRow('Địa chỉ', req.dia_chi_nguoi_mua)}
                        ${infoRow('Số CCCD', req.so_cccd_nguoi_mua)}
                        ${infoRow('Ngày cấp CCCD', req.ngay_cap_cccd_nguoi_mua)}
                        ${infoRow('Số điện thoại', req.so_dien_thoai_nguoi_mua)}
                        ${infoRow('Bản sao chuyển nhượng', req.ban_sao_chuyen_nhuong)}
                    </div>
                </div>
                ` : ''}

                <!-- Current User Info (Form 10) -->
                ${req.ten_nguoi_dang_su_dung ? `
                <div class="bg-white border-2 border-purple-200 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-purple-200">
                        <svg class="w-5 h-5 inline mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Thông tin người đang sử dụng
                    </h4>
                    <div class="text-sm space-y-1">
                        ${infoRow('Họ và tên', req.ten_nguoi_dang_su_dung)}
                        ${infoRow('Địa chỉ', req.dia_chi_nguoi_dang_su_dung)}
                    </div>
                </div>
                ` : ''}

                <!-- Seller Info (Form 10) -->
                ${req.ten_nguoi_ban ? `
                <div class="bg-white border-2 border-orange-200 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-orange-200">
                        <svg class="w-5 h-5 inline mr-2 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        Thông tin người bán
                    </h4>
                    <div class="text-sm space-y-1">
                        ${infoRow('Họ và tên', req.ten_nguoi_ban)}
                        ${infoRow('Địa chỉ', req.dia_chi_nguoi_ban)}
                        ${infoRow('Số điện thoại', req.so_dien_thoai_nguoi_ban)}
                        ${infoRow('Số CCCD', req.so_cccd_nguoi_ban)}
                        ${infoRow('Ngày cấp CCCD', req.ngay_cap_cccd_nguoi_ban)}
                    </div>
                </div>
                ` : ''}

                <!-- Notes -->
                ${req.ghi_chu ? `
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-3 pb-2 border-b-2 border-gray-200">
                        <svg class="w-5 h-5 inline mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                        Ghi chú
                    </h4>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${req.ghi_chu}</p>
                </div>
                ` : ''}
            `;

            // Show modal
            document.getElementById('requestDetailModal').classList.remove('hidden');
        } catch (error) {
            console.error('Error loading request detail:', error);
            alert('Có lỗi xảy ra khi tải thông tin yêu cầu');
        }
    }

    function closeRequestDetailModal() {
        document.getElementById('requestDetailModal').classList.add('hidden');
    }

    function confirmCorrect() {
        // Determine form based on vehicle type (biển xanh = 1, biển trắng/vàng = 6)
        const mauBien = document.getElementById('result_bien_so').textContent;
        const loaiMau = mauBien.includes('B') ? 1 : 6;  // Simple logic, can be improved
        window.location.href = `/yeu-cau/mau-${loaiMau}?bien_so=${currentBienSo}`;
    }

    function showFormOptions() {
        document.getElementById('formModal').classList.remove('hidden');
    }

    function closeFormModal() {
        document.getElementById('formModal').classList.add('hidden');
    }

    function goToForm(mau) {
        window.location.href = `/yeu-cau/mau-${mau}?bien_so=${currentBienSo}`;
    }

    function submitNewVehicle() {
        // For new vehicle not in list (Form 5 or 10)
        window.location.href = `/yeu-cau/mau-5?bien_so=${currentBienSo}`;
    }
</script>
{% endblock %}
