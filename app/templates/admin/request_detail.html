{% extends "base.html" %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-3xl font-bold text-gray-800">Chi tiết yêu cầu</h2>
        <p class="text-gray-600">Mã yêu cầu: <strong class="font-mono text-blue-600">{{ req.id }}</strong></p>
    </div>
    <a href="/admin/yeu-cau" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
        Quay lại danh sách
    </a>
</div>

<!-- Status Card -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <div class="flex items-center justify-between">
        <div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Trạng thái yêu cầu</h3>
            <div class="flex items-center space-x-4">
                {% if req.trang_thai == 'pending' %}
                    <span class="px-4 py-2 bg-orange-100 text-orange-800 rounded-full font-medium">
                        Chờ xử lý
                    </span>
                {% elif req.trang_thai == 'approved' %}
                    <span class="px-4 py-2 bg-blue-100 text-blue-800 rounded-full font-medium">
                        Đã phê duyệt
                    </span>
                {% elif req.trang_thai == 'rejected' %}
                    <span class="px-4 py-2 bg-red-100 text-red-800 rounded-full font-medium">
                        Từ chối
                    </span>
                {% else %}
                    <span class="px-4 py-2 bg-green-100 text-green-800 rounded-full font-medium">
                        Đã xử lý
                    </span>
                {% endif %}

                {% if req.nguoi_duyet %}
                    <span class="text-gray-600">
                        Người duyệt: <strong>{{ req.nguoi_duyet }}</strong>
                    </span>
                    <span class="text-gray-600">
                        Ngày duyệt: <strong>{{ req.ngay_duyet.strftime('%d/%m/%Y %H:%M') }}</strong>
                    </span>
                {% endif %}
            </div>
        </div>

        <div class="flex space-x-2">
            {% if req.trang_thai == 'pending' %}
                <button onclick="approveRequest('{{ req.id }}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    Phê duyệt
                </button>
                <button onclick="rejectRequest('{{ req.id }}')" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Từ chối
                </button>
            {% elif req.trang_thai == 'approved' %}
                <button onclick="markProcessed('{{ req.id }}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Đánh dấu đã xử lý
                </button>
            {% endif %}
        </div>
    </div>

    {% if req.ly_do_tu_choi %}
        <div class="mt-4 p-4 bg-red-50 border-l-4 border-red-500">
            <p class="text-red-800"><strong>Lý do từ chối:</strong> {{ req.ly_do_tu_choi }}</p>
        </div>
    {% endif %}
</div>

<!-- Request Information -->
<div class="grid md:grid-cols-2 gap-6 mb-6">
    <!-- Basic Information -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Thông tin cơ bản</h3>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-600">Biển số xe:</span>
                <span class="font-semibold">{{ req.bien_so }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Màu biển:</span>
                <span class="font-semibold">{{ req.mau_bien or '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Loại biểu mẫu:</span>
                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm font-medium">Mẫu {{ req.loai_mau }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-600">Version:</span>
                <div class="flex items-center space-x-2">
                    <span class="px-3 py-1 bg-gray-100 text-gray-800 rounded font-semibold">v{{ req.version }}</span>
                    {% if req.is_latest_approved %}
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded font-bold text-xs">✓ LATEST APPROVED</span>
                    {% endif %}
                </div>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Loại xe:</span>
                <span class="font-semibold">{{ req.loai_xe or '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Đợt dữ liệu:</span>
                <span class="font-semibold">{{ req.batch_name or '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Ngày tạo:</span>
                <span class="font-semibold">{{ req.ngay_tao.strftime('%d/%m/%Y %H:%M') }}</span>
            </div>
        </div>
    </div>

    <!-- Vehicle Identification -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Thông tin xe</h3>
        <div class="space-y-3">
            <div class="flex justify-between">
                <span class="text-gray-600">Số khung:</span>
                <span class="font-semibold font-mono">{{ req.so_khung or '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Số máy:</span>
                <span class="font-semibold font-mono">{{ req.so_may or '-' }}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600">Tình trạng xe:</span>
                <span class="font-semibold">{{ req.tinh_trang_xe or '-' }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Owner Information -->
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Thông tin chủ xe</h3>
    <div class="grid md:grid-cols-3 gap-4">
        <div>
            <label class="text-gray-600 text-sm">Tên chủ xe:</label>
            <p class="font-semibold">{{ req.chu_xe or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Số điện thoại:</label>
            <p class="font-semibold">{{ req.so_dien_thoai_chu_xe or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Số CCCD/Mã số thuế:</label>
            <p class="font-semibold font-mono">{{ req.ma_so_thue_chu_xe or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Ngày cấp CCCD:</label>
            <p class="font-semibold">{{ req.ngay_cap_cccd_chu_xe or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Số GPLX:</label>
            <p class="font-semibold font-mono">{{ req.so_gplx_chu_xe or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Ngày cấp GPLX:</label>
            <p class="font-semibold">{{ req.ngay_cap_gplx_chu_xe or '-' }}</p>
        </div>
        <div class="md:col-span-3">
            <label class="text-gray-600 text-sm">Cơ quan cấp GPLX:</label>
            <p class="font-semibold">{{ req.co_quan_cap_gplx_chu_xe or '-' }}</p>
        </div>
        <div class="md:col-span-3">
            <label class="text-gray-600 text-sm">Địa chỉ:</label>
            <p class="font-semibold">{{ req.dia_chi_chu_xe or '-' }}</p>
        </div>
    </div>
</div>

<!-- Buyer/Transfer Information (if applicable) -->
{% if req.ten_nguoi_mua or req.loai_mau in [2, 3, 4, 7, 8, 9] %}
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Thông tin người mua/đang sử dụng</h3>
    <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2">
            <label class="text-gray-600 text-sm">Tên người mua/đang sử dụng:</label>
            <p class="font-semibold">{{ req.ten_nguoi_mua or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Số điện thoại:</label>
            <p class="font-semibold">{{ req.so_dien_thoai_nguoi_mua or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Số CCCD/Mã số thuế:</label>
            <p class="font-semibold font-mono">{{ req.so_cccd_nguoi_mua or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Ngày cấp CCCD:</label>
            <p class="font-semibold">{{ req.ngay_cap_cccd_nguoi_mua or '-' }}</p>
        </div>
        <div>
            <label class="text-gray-600 text-sm">Bản sao chứng từ chuyển nhượng:</label>
            <p class="font-semibold">{{ req.ban_sao_chuyen_nhuong or '-' }}</p>
        </div>
        <div class="md:col-span-3">
            <label class="text-gray-600 text-sm">Địa chỉ:</label>
            <p class="font-semibold">{{ req.dia_chi_nguoi_mua or '-' }}</p>
        </div>
    </div>
</div>
{% endif %}

<!-- Form 10 Specific: Seller and Current User Information -->
{% if req.loai_mau == 10 %}
<div class="grid md:grid-cols-2 gap-6 mb-6">
    <!-- Current User Information -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Người đang sử dụng xe</h3>
        <div class="space-y-3">
            <div>
                <label class="text-gray-600 text-sm">Tên:</label>
                <p class="font-semibold">{{ req.ten_nguoi_dang_su_dung or '-' }}</p>
            </div>
            <div>
                <label class="text-gray-600 text-sm">Địa chỉ:</label>
                <p class="font-semibold">{{ req.dia_chi_nguoi_dang_su_dung or '-' }}</p>
            </div>
        </div>
    </div>

    <!-- Seller Information -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Người bán xe</h3>
        <div class="space-y-3">
            <div>
                <label class="text-gray-600 text-sm">Tên:</label>
                <p class="font-semibold">{{ req.ten_nguoi_ban or '-' }}</p>
            </div>
            <div>
                <label class="text-gray-600 text-sm">Địa chỉ:</label>
                <p class="font-semibold">{{ req.dia_chi_nguoi_ban or '-' }}</p>
            </div>
            <div>
                <label class="text-gray-600 text-sm">Số điện thoại:</label>
                <p class="font-semibold">{{ req.so_dien_thoai_nguoi_ban or '-' }}</p>
            </div>
            <div>
                <label class="text-gray-600 text-sm">Số CCCD/Mã số thuế:</label>
                <p class="font-semibold font-mono">{{ req.so_cccd_nguoi_ban or '-' }}</p>
            </div>
            <div>
                <label class="text-gray-600 text-sm">Ngày cấp CCCD:</label>
                <p class="font-semibold">{{ req.ngay_cap_cccd_nguoi_ban or '-' }}</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Additional Notes -->
{% if req.ghi_chu %}
<div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Ghi chú</h3>
    <p class="text-gray-700">{{ req.ghi_chu }}</p>
</div>
{% endif %}

<!-- Modal for rejection reason -->
<div id="rejectModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Lý do từ chối</h3>
            <textarea id="rejectReason" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="4" placeholder="Nhập lý do từ chối..."></textarea>
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeRejectModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300">
                    Hủy
                </button>
                <button onclick="confirmReject()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                    Xác nhận từ chối
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentRequestId = '{{ req.id }}';

    async function approveRequest(requestId) {
        if (!confirm('Bạn có chắc chắn muốn phê duyệt yêu cầu này?')) {
            return;
        }

        try {
            const response = await fetch(`/admin/request/${requestId}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Có lỗi xảy ra: ' + data.message);
            }
        } catch (error) {
            alert('Có lỗi xảy ra khi phê duyệt yêu cầu');
            console.error(error);
        }
    }

    function rejectRequest(requestId) {
        currentRequestId = requestId;
        document.getElementById('rejectModal').classList.remove('hidden');
        document.getElementById('rejectReason').value = '';
    }

    function closeRejectModal() {
        document.getElementById('rejectModal').classList.add('hidden');
    }

    async function confirmReject() {
        const reason = document.getElementById('rejectReason').value.trim();

        if (!reason) {
            alert('Vui lòng nhập lý do từ chối');
            return;
        }

        try {
            const response = await fetch(`/admin/request/${currentRequestId}/reject?reason=${encodeURIComponent(reason)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                closeRejectModal();
                location.reload();
            } else {
                alert('Có lỗi xảy ra: ' + data.message);
            }
        } catch (error) {
            alert('Có lỗi xảy ra khi từ chối yêu cầu');
            console.error(error);
        }
    }

    async function markProcessed(requestId) {
        if (!confirm('Bạn có chắc chắn đã gửi yêu cầu này cho cơ quan nhà nước?')) {
            return;
        }

        try {
            const response = await fetch(`/admin/request/${requestId}/mark-processed`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Có lỗi xảy ra: ' + data.message);
            }
        } catch (error) {
            alert('Có lỗi xảy ra khi đánh dấu yêu cầu');
            console.error(error);
        }
    }
</script>
{% endblock %}
